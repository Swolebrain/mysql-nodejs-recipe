<!doctype html>
<html>
    <head>
        <title>Donation Collection Page</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link rel='stylesheet' href='style.css' />
    </head>
    <body>
      <div id='pagination'>
        <a class='btn btn-primary' href='index.html'>Reports</a>
        <a class='btn btn-primary' href='collection.html'>Input transactions</a>
        <a class='btn btn-primary' href='donations.html'>Show Transactions</a>
      </div>
      <div class="container">
          <h1>Record Donations:</h1>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id1">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id1">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name1' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation1">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation1">
              </div>

          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id2">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id2">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name2' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation2">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation2">
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id3">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id3">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name3' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation3">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation3">
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id4">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id4">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name4' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation4">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation4">
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id5">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id5">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name5' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation5">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation5">
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id6">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id6">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name6' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation6">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation6">
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id7">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id7">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name7' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation7">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation7">
              </div>
          </div>
          <div class="row">
              <div class="col-xs-12 col-md-4 col-md-push-1 form-group">
                  <label for="student-id8">Student ID</label>
                  <input class="form-control idinput" type="text" id="student-id8">
              </div>
              <div class='col-xs-12 col-md-3 form-group'>
                  <span id='student-name8' class='studentspan'></span>
              </div>
              <div class="col-xs-12 col-md-4">
                  <label for="student-donation8">Student Donation</label>
                  <input class="form-control" type="text" id="student-donation8">
              </div>
          </div>
          <div class="row">
              <center>
                  <button class="btn btn-primary" id="btn-submit">Submit</button>
                  <button class="btn btn-primary" id="btn-reset">Start Over</button>
              </center>
          </div>
          <div id='results'>

          </div>
      </div>
      <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
      <script>
          let gen = fireAllAjaxRequests();

          $("#btn-reset").on('click', reset);

          $("#btn-submit").on("click", clickHandler);

          function clickHandler(){
              $("#btn-submit").off("click");
              $("#btn-submit").html("Processing...");
              gen.next();
          }
          function reset(){
            $("input").val("");
            $("#results").html("");
            $('.studentspan').html('');
          }
          function* fireAllAjaxRequests(){
            let responses = [];
            for (let i = 1; i <= 8; i++){
              let sidInput = $("#student-id"+i).val().trim();
              let donationInput = $("#student-donation"+i).val().trim();
              if (sidInput.length === 5 && donationInput.length > 0){
                responses.push(yield postTransaction(i, responses));
                console.log('processing request '+i);
              }
              else if (sidInput.length === 5 || donationInput.length > 0){
                responses.push('invalid input')
              }
            }
            $("#btn-submit").on("click", clickHandler);
            $("#btn-submit").html("Submit");
            console.log(responses);
            responses.forEach( (e,i)=> $('#results').append(`<p>
                Transaction ${i+1}: ${responses[i]}
              </p>`));
            let numFails = responses.reduce( (p,c)=> c==='Success'?p+0:p+1,0);
            if (numFails === 0){
              setTimeout(function(){
                reset();
              },1500);
            }
            gen = fireAllAjaxRequests();
          }
          function postTransaction(i){
            $.ajax({
                url: "transactions/"+
                $("#student-id"+i).val()+"/"+$("#student-donation"+i).val(),
                method: "POST",
                success: function(res, txt, xhr){
                  gen.next(res);
                },
                error: function(err){
                  gen.next(err);
                }
            });
          }

          $('.idinput').on('change', function(){
            let sid = $(this).val();
            let span = '#student-name'+$(this).attr('id').slice(-1);
            let $span = $(span);
            $.ajax({
              url: 'student-name/'+sid,
              success: function(res, txt, xhr){
                $span.html(res);
              }
            });
          });
      </script>
    </body>
</html>
